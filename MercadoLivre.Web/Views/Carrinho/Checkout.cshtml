@model Usuario

@{
    ViewData["Title"] = "Finalizar compra";
}

<div class="container my-4">
    
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Início</a></li>
            <li class="breadcrumb-item"><a asp-controller="Carrinho" asp-action="Index">Carrinho</a></li>
            <li class="breadcrumb-item active">Finalizar compra</li>
        </ol>
    </nav>

    <h2 class="mb-4"><i class="fas fa-credit-card"></i> Finalizar compra</h2>

    <div class="row">
        
        <div class="col-lg-8">
            <form asp-action="FinalizarPedido" method="post">
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Endereço de entrega</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="endereco" class="form-label">Endereço completo:</label>
                                    <input type="text" name="endereco" id="endereco" class="form-control" 
                                           value="@Model.Endereco" placeholder="Rua, número, complemento">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cep" class="form-label">CEP:</label>
                                    <input type="text" name="cep" id="cep" class="form-control" 
                                           value="@Model.CEP" placeholder="00000-000" maxlength="9">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cidade" class="form-label">Cidade:</label>
                                    <input type="text" name="cidade" id="cidade" class="form-control" 
                                           value="@Model.Cidade" placeholder="Cidade">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado:</label>
                                    <select name="estado" id="estado" class="form-select">
                                        <option value="">Selecione o estado</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amapá</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Ceará</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Espírito Santo</option>
                                        <option value="GO">Goiás</option>
                                        <option value="MA">Maranhão</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Pará</option>
                                        <option value="PB">Paraíba</option>
                                        <option value="PR">Paraná</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piauí</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="RO">Rondônia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SP">São Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Frete grátis</strong> para todo o Brasil. Entrega em 2-5 dias úteis.
                        </div>
                    </div>
                </div>

                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-credit-card"></i> Forma de pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="formaPagamento" id="pix" value="PIX" checked>
                                    <label class="form-check-label" for="pix">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-qrcode fa-lg me-3 text-primary"></i>
                                            <div>
                                                <strong>PIX</strong>
                                                <div class="small text-muted">Aprovação instantânea</div>
                                                <span class="badge bg-success">10% de desconto</span>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="formaPagamento" id="cartao-credito" value="CartaoCredito">
                                    <label class="form-check-label" for="cartao-credito">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-credit-card fa-lg me-3 text-primary"></i>
                                            <div>
                                                <strong>Cartão de Crédito</strong>
                                                <div class="small text-muted">Em até 12x sem juros</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="formaPagamento" id="cartao-debito" value="CartaoDebito">
                                    <label class="form-check-label" for="cartao-debito">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-credit-card fa-lg me-3 text-primary"></i>
                                            <div>
                                                <strong>Cartão de Débito</strong>
                                                <div class="small text-muted">Débito na conta</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="formaPagamento" id="boleto" value="Boleto">
                                    <label class="form-check-label" for="boleto">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-barcode fa-lg me-3 text-primary"></i>
                                            <div>
                                                <strong>Boleto Bancário</strong>
                                                <div class="small text-muted">Vencimento em 3 dias</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        
                        <div id="cartao-detalhes" class="mt-3" style="display: none;">
                            <hr>
                            <h6>Dados do cartão</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="numero-cartao" class="form-label">Número do cartão:</label>
                                        <input type="text" id="numero-cartao" class="form-control" placeholder="0000 0000 0000 0000" maxlength="19">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="cvv" class="form-label">CVV:</label>
                                        <input type="text" id="cvv" class="form-control" placeholder="000" maxlength="4">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="nome-cartao" class="form-label">Nome no cartão:</label>
                                        <input type="text" id="nome-cartao" class="form-control" placeholder="Nome como está no cartão">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="validade" class="form-label">Validade:</label>
                                        <input type="text" id="validade" class="form-control" placeholder="MM/AA" maxlength="5">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="parcelas" class="form-label">Parcelas:</label>
                                        <select id="parcelas" class="form-select">
                                            <option value="1">1x R$ @Model.ItensCarrinho.Sum(i => i.SubTotal).ToString("N2") sem juros</option>
                                            <option value="2">2x R$ @(Model.ItensCarrinho.Sum(i => i.SubTotal) / 2).ToString("N2") sem juros</option>
                                            <option value="3">3x R$ @(Model.ItensCarrinho.Sum(i => i.SubTotal) / 3).ToString("N2") sem juros</option>
                                            <option value="6">6x R$ @(Model.ItensCarrinho.Sum(i => i.SubTotal) / 6).ToString("N2") sem juros</option>
                                            <option value="12">12x R$ @(Model.ItensCarrinho.Sum(i => i.SubTotal) / 12).ToString("N2") sem juros</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="aceita-termos" required>
                            <label class="form-check-label" for="aceita-termos">
                                Aceito os <a href="#" class="text-decoration-none">termos e condições</a> e 
                                <a href="#" class="text-decoration-none">políticas de privacidade</a>
                            </label>
                        </div>
                    </div>
                </div>

                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-ml-primary btn-lg">
                        <i class="fas fa-lock"></i> Finalizar compra
                    </button>
                </div>
            </form>
        </div>

        
        <div class="col-lg-4">
            <div class="checkout-summary">
                <h5 class="mb-4"><i class="fas fa-receipt"></i> Resumo do pedido</h5>
                
                
                @foreach (var item in Model.ItensCarrinho)
                {
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <div class="d-flex">
                            @if (!string.IsNullOrEmpty(item.Produto.ImagemPrincipal))
                            {
                                <img src="@item.Produto.ImagemPrincipal" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@item.Produto.Nome">
                            }
                            else
                            {
                                <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            }
                            <div>
                                <h6 class="mb-1">@item.Produto.Nome</h6>
                                <small class="text-muted">Qty: @item.Quantidade</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">R$ @item.SubTotal.ToString("N2")</div>
                        </div>
                    </div>
                }
                
                <div class="summary-line">
                    <span>Subtotal (@Model.ItensCarrinho.Sum(i => i.Quantidade) itens)</span>
                    <span class="fw-bold">R$ @Model.ItensCarrinho.Sum(i => i.SubTotal).ToString("N2")</span>
                </div>
                
                <div class="summary-line">
                    <span>Frete</span>
                    <span class="text-success fw-bold">Grátis</span>
                </div>
                
                <div class="summary-line text-success" id="desconto-pix" style="display: none;">
                    <span>Desconto PIX (10%)</span>
                    <span>-R$ @(Model.ItensCarrinho.Sum(i => i.SubTotal) * 0.1m).ToString("N2")</span>
                </div>
                
                <div class="summary-total">
                    <div class="summary-line">
                        <span>Total</span>
                        <span class="text-ml-primary" id="total-valor">R$ @Model.ItensCarrinho.Sum(i => i.SubTotal).ToString("N2")</span>
                    </div>
                </div>

                
                <div class="mt-4 p-3 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-wallet"></i> Seu saldo:</span>
                        <span class="fw-bold text-success">R$ @Model.Saldo.ToString("N2")</span>
                    </div>
                    @{
                        var totalComFrete = Model.ItensCarrinho.Sum(i => i.SubTotal) + 15.90m; // Considerando frete fixo
                        var saldoSuficiente = Model.Saldo >= totalComFrete;
                    }
                    @if (!saldoSuficiente)
                    {
                        <small class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Saldo insuficiente para esta compra
                        </small>
                    }
                </div>

                
                <div class="mt-4">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        <small>Compra 100% protegida</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-truck text-success me-2"></i>
                        <small>Frete grátis para todo Brasil</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-undo text-success me-2"></i>
                        <small>7 dias para devolução</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const subtotal = @Model.ItensCarrinho.Sum(i => i.SubTotal);
            
            // Mostrar/ocultar campos do cartão
            $('input[name="formaPagamento"]').on('change', function() {
                const isCartao = $(this).val().includes('Cartao');
                $('#cartao-detalhes').toggle(isCartao);
                
                // Calcular desconto PIX
                const isPix = $(this).val() === 'PIX';
                $('#desconto-pix').toggle(isPix);
                
                if (isPix) {
                    const totalComDesconto = subtotal * 0.9;
                    $('#total-valor').text('R$ ' + totalComDesconto.toFixed(2).replace('.', ','));
                } else {
                    $('#total-valor').text('R$ ' + subtotal.toFixed(2).replace('.', ','));
                }
            });

            // Máscaras para cartão
            $('#numero-cartao').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                $(this).val(value);
            });

            $('#validade').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                value = value.replace(/^(\d{2})(\d)/, '$1/$2');
                $(this).val(value);
            });

            $('#cvv').on('input', function() {
                $(this).val($(this).val().replace(/\D/g, ''));
            });

            // Validação do formulário
            $('form').on('submit', function(e) {
                const formaPagamento = $('input[name="formaPagamento"]:checked').val();
                
                if (formaPagamento.includes('Cartao')) {
                    const numeroCartao = $('#numero-cartao').val().replace(/\D/g, '');
                    const cvv = $('#cvv').val();
                    const nomeCartao = $('#nome-cartao').val();
                    const validade = $('#validade').val();
                    
                    if (!numeroCartao || numeroCartao.length < 16) {
                        e.preventDefault();
                        showToast('error', 'Número do cartão inválido');
                        return;
                    }
                    
                    if (!cvv || cvv.length < 3) {
                        e.preventDefault();
                        showToast('error', 'CVV inválido');
                        return;
                    }
                    
                    if (!nomeCartao) {
                        e.preventDefault();
                        showToast('error', 'Nome no cartão é obrigatório');
                        return;
                    }
                    
                    if (!validade || validade.length < 5) {
                        e.preventDefault();
                        showToast('error', 'Validade do cartão inválida');
                        return;
                    }
                }
                
                if (!$('#aceita-termos').is(':checked')) {
                    e.preventDefault();
                    showToast('error', 'Você deve aceitar os termos e condições');
                    return;
                }
            });
        });
    </script>
}
